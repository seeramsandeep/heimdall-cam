<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heimdall Live Video Streaming Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* CSS styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #ff6b35;
        }

        .brand {
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 3px;
            color: #ff6b35;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            margin-top: 5px;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .connection-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .connected {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .disconnected {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
        }

        .dashboard {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: calc(100vh - 120px);
        }

        .streams-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .streams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stream-card {
            background: rgba(0,0,0,0.6);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            min-height: 400px;
        }

        .stream-card.active {
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0,255,0,0.3);
        }

        .stream-card.live-streaming {
            border-color: #ff0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.4);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 20px rgba(255,0,0,0.4); }
            50% { box-shadow: 0 0 30px rgba(255,0,0,0.8); }
            100% { box-shadow: 0 0 20px rgba(255,0,0,0.4); }
        }

        .stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .device-id {
            font-weight: bold;
            color: #ff6b35;
            font-size: 1.1em;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff0000;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #00ff00;
        }

        .frame-counter {
            font-size: 0.8em;
            color: #ccc;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .video-container {
            width: 100%;
            height: 280px;
            background: #000;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #333;
        }

        .video-frame {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            transition: none;
        }

        .no-video {
            color: #666;
            font-size: 0.9em;
            text-align: center;
            padding: 20px;
        }

        .stream-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,0,0,0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .fps-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .stream-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .analysis-preview {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85em;
            min-height: 80px;
        }

        .analysis-title {
            color: #ff6b35;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .analysis-loading {
            color: #ffa500;
            font-style: italic;
        }

        .analysis-complete {
            color: #00ff00;
        }

        .analysis-error {
            color: #ff6b35;
        }

        .sidebar {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .alerts-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #ff6b35;
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 5px;
        }

        .alert-item {
            background: rgba(255,0,0,0.2);
            border-left: 4px solid #ff0000;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-critical {
            border-left-color: #ff0000;
            background: rgba(255,0,0,0.3);
        }

        .alert-warning {
            border-left-color: #ffa500;
            background: rgba(255,165,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b35;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .streams-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="brand">HEIMDALL</div>
        <div class="subtitle">Live Video Streaming Dashboard</div>
        <div id="connection-status" class="connection-status disconnected">
            Connecting to server...
        </div>
    </div>

    <div class="dashboard">
        <div class="streams-container">
            <h2 class="section-title">üìπ Live Video Streams</h2>
            <div id="streams-grid" class="streams-grid">
                <div class="loading">Connecting to server...</div>
            </div>
        </div>

        <div class="sidebar">
            <div class="alerts-section">
                <h3 class="section-title">üö® Security Alerts</h3>
                <div id="alerts-container">
                    <div class="loading">No alerts</div>
                </div>
            </div>

            <div class="stats-section">
                <h3 class="section-title">üìä Live Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="active-streams">0</div>
                        <div class="stat-label">Active Streams</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-alerts">0</div>
                        <div class="stat-label">Total Alerts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="people-detected">0</div>
                        <div class="stat-label">People Detected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="risk-level">NORMAL</div>
                        <div class="stat-label">Risk Level</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://0cc63893afff.ngrok-free.app'; // Ensure this URL is correct
        
        console.log('üéØ Initializing Heimdall Dashboard');
        console.log('üåê Connecting to:', BACKEND_URL);
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket'],
            extraHeaders: {
                'ngrok-skip-browser-warning': 'true'
            },
            forceNew: true,
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 2000
        });
        
        const activeStreams = new Map();
        const alerts = [];
        let totalPeopleDetected = 0;
        let currentRiskLevel = 'NORMAL';

        // DOM elements
        const connectionStatus = document.getElementById('connection-status');
        const streamsGrid = document.getElementById('streams-grid');
        const alertsContainer = document.getElementById('alerts-container');
        const activeStreamsCount = document.getElementById('active-streams');
        const totalAlertsCount = document.getElementById('total-alerts');
        const peopleDetectedCount = document.getElementById('people-detected');
        const riskLevelElement = document.getElementById('risk-level');

        // Socket event handlers
        socket.on('connect', () => {
            console.log('‚úÖ Connected to Heimdall streaming server');
            connectionStatus.textContent = 'üü¢ Connected - Live Streaming Ready';
            connectionStatus.className = 'connection-status connected';
            socket.emit('register-dashboard');
            loadActiveStreams();
        });

        socket.on('disconnect', (reason) => {
            console.log('‚ùå Disconnected from server:', reason);
            connectionStatus.textContent = 'üî¥ Disconnected from Server';
            connectionStatus.className = 'connection-status disconnected';
        });

        socket.on('connect_error', (error) => {
            console.error('‚ùå Connection error:', error);
            connectionStatus.textContent = '‚ùå Connection Error';
            connectionStatus.className = 'connection-status disconnected';
        });

        socket.on('current-streams', (data) => {
            console.log('üì° Received current streams:', data);
            streamsGrid.innerHTML = ''; // Clear existing streams before adding new ones
            if (data.streams && data.streams.length > 0) {
                data.streams.forEach(stream => {
                    addStream(stream.deviceId, stream.sessionId, stream.startTime, stream.videoStreamActive);
                    if (stream.lastFrame) {
                        updateVideoFrame(stream.deviceId, stream.lastFrame, stream.frameCount, stream.fps);
                    }
                });
            } else {
                streamsGrid.innerHTML = '<div class="loading">No active streams</div>';
            }
        });

        socket.on('stream-started', (data) => {
            console.log('üé¨ Live stream started:', data);
            addStream(data.deviceId, data.sessionId, data.startTime, true);
        });

        socket.on('stream-stopped', (data) => {
            console.log('üõë Live stream stopped:', data);
            removeStream(data.deviceId);
        });

        // *** THIS IS THE FIX ***
        // Listen for the correct event name: 'live-video-frame'
        socket.on('live-video-frame', (data) => {
            // This console log should now appear
            console.log(`üìπ Received live frame ${data.frameNumber} from device: ${data.deviceId}`);
            updateVideoFrame(data.deviceId, data.frame, data.frameNumber, data.fps);
        });

        socket.on('analysis-status', (data) => {
            console.log('ü§ñ Analysis status update:', data);
            updateAnalysisStatus(data.deviceId, data.status, data.chunkId);
        });

        socket.on('analysis-result', (data) => {
            console.log('üìä Analysis result received:', data);
            updateStreamAnalysis(data);
        });

        socket.on('analysis-error', (data) => {
            console.log('‚ùå Analysis error:', data);
            updateAnalysisError(data.deviceId, data.error);
        });

        socket.on('security-alert', (data) => {
            console.log('üö® Security alert:', data);
            addAlert(data);
        });
        
        function addStream(deviceId, sessionId, startTime = new Date(), isLiveStreaming = false) {
            if (activeStreams.has(deviceId)) {
                console.log(`Stream ${deviceId} already exists, updating status.`);
                const streamCard = document.getElementById(`stream-${deviceId}`);
                if(streamCard) {
                   streamCard.className = `stream-card ${isLiveStreaming ? 'live-streaming' : 'active'}`;
                }
                return;
            }

            console.log(`‚ûï Adding stream for device: ${deviceId}`);

            activeStreams.set(deviceId, {
                sessionId,
                startTime: new Date(startTime),
                lastAnalysis: null,
                frameCount: 0,
                lastFrameTime: null,
                isLiveStreaming: isLiveStreaming,
                fps: 0,
            });

            const streamCard = document.createElement('div');
            streamCard.className = `stream-card ${isLiveStreaming ? 'live-streaming' : 'active'}`;
            streamCard.id = `stream-${deviceId}`;
            
            streamCard.innerHTML = `
                <div class="stream-header">
                    <div class="device-id">üì± Device: ${deviceId.substring(0, 8)}...</div>
                    <div class="status-indicator">
                        <div class="status-dot ${isLiveStreaming ? 'active' : ''}"></div>
                        <div class="frame-counter" id="frame-counter-${deviceId}">
                            ${isLiveStreaming ? 'üî¥ LIVE' : 'Offline'}
                        </div>
                    </div>
                </div>
                <div class="video-container">
                    <img id="video-frame-${deviceId}" class="video-frame" style="display: none;" alt="Live Stream">
                    <div id="no-video-${deviceId}" class="no-video">
                        ${isLiveStreaming ? 'üìπ Connecting to live stream...' : 'üìπ Waiting for video stream...'}
                    </div>
                    <div class="stream-overlay" id="stream-overlay-${deviceId}">
                        ${isLiveStreaming ? 'üî¥ LIVE' : 'OFFLINE'}
                    </div>
                    <div class="fps-counter" id="fps-counter-${deviceId}">0 FPS</div>
                </div>
                <div class="stream-info">
                    <div>Session: ${sessionId.substring(0, 12)}...</div>
                    <div>Started: ${formatTime(startTime)}</div>
                    <div id="stream-quality-${deviceId}">Quality: Connecting...</div>
                </div>
                <div class="analysis-preview" id="analysis-${deviceId}">
                    <div class="analysis-title">ü§ñ AI Analysis</div>
                    <div class="analysis-loading">Waiting for analysis...</div>
                </div>
            `;
            
            if (streamsGrid.innerHTML.includes('No active streams') || streamsGrid.innerHTML.includes('Connecting to server')) {
                streamsGrid.innerHTML = '';
            }

            streamsGrid.appendChild(streamCard);
            updateStats();
        }
        
        function updateVideoFrame(deviceId, frameData, frameNumber, fps) {
            const frameElement = document.getElementById(`video-frame-${deviceId}`);
            const noVideoElement = document.getElementById(`no-video-${deviceId}`);
            const frameCounterElement = document.getElementById(`frame-counter-${deviceId}`);
            const streamOverlayElement = document.getElementById(`stream-overlay-${deviceId}`);
            const fpsCounterElement = document.getElementById(`fps-counter-${deviceId}`);
            const streamQualityElement = document.getElementById(`stream-quality-${deviceId}`);
            const streamCard = document.getElementById(`stream-${deviceId}`);
            
            if (frameElement && frameData) {
                frameElement.src = frameData;
                frameElement.style.display = 'block';
                
                if (noVideoElement) noVideoElement.style.display = 'none';
                
                if (frameCounterElement) frameCounterElement.textContent = `üî¥ LIVE (${frameNumber})`;
                if (streamOverlayElement) streamOverlayElement.textContent = 'üî¥ LIVE';
                if (fpsCounterElement) fpsCounterElement.textContent = `${fps || 0} FPS`;
                
                if (streamQualityElement) {
                    const quality = fps >= 8 ? 'Excellent' : fps >= 5 ? 'Good' : fps >= 2 ? 'Fair' : 'Poor';
                    streamQualityElement.textContent = `Quality: ${quality} (${fps} FPS)`;
                }
                
                if (streamCard && !streamCard.classList.contains('live-streaming')) {
                    streamCard.classList.remove('active');
                    streamCard.classList.add('live-streaming');
                }
                
                if (activeStreams.has(deviceId)) {
                    const stream = activeStreams.get(deviceId);
                    stream.frameCount = frameNumber;
                    stream.lastFrameTime = new Date();
                    stream.isLiveStreaming = true;
                    stream.fps = fps;
                    activeStreams.set(deviceId, stream);
                }
            } else {
                console.warn(`‚ö†Ô∏è Invalid frame data for device ${deviceId}`);
            }
        }

        function removeStream(deviceId) {
            activeStreams.delete(deviceId);
            const streamElement = document.getElementById(`stream-${deviceId}`);
            if (streamElement) {
                streamElement.remove();
            }

            if (activeStreams.size === 0) {
                streamsGrid.innerHTML = '<div class="loading">No active streams</div>';
            }

            updateStats();
        }

        // --- Other JavaScript functions (updateAnalysisStatus, updateStreamAnalysis, etc.) remain unchanged ---

        function updateAnalysisStatus(deviceId, status, chunkId) {
            const analysisElement = document.getElementById(`analysis-${deviceId}`);
            if (!analysisElement) return;
            let statusHtml = '<div class="analysis-title">ü§ñ AI Analysis</div>';
            switch (status) {
                case 'processing': statusHtml += `<div class="analysis-loading">üì• Processing chunk ${chunkId}...</div>`; break;
                case 'analyzing': statusHtml += `<div class="analysis-loading">ü§ñ Analyzing video content...</div>`; break;
                case 'error': statusHtml += `<div class="analysis-error">‚ùå Analysis failed</div>`; break;
                default: statusHtml += `<div class="analysis-loading">‚è≥ Status: ${status}</div>`;
            }
            analysisElement.innerHTML = statusHtml;
        }

        function updateStreamAnalysis(data) {
            const analysisElement = document.getElementById(`analysis-${data.deviceId}`);
            if (!analysisElement) return;
            const { labels, personDetection, summary, crowdAnalysis } = data;
            let analysisHtml = '<div class="analysis-title">ü§ñ AI Analysis</div><div class="analysis-complete">‚úÖ Analysis Complete</div>';
            if (summary) analysisHtml += `<div><strong>Summary:</strong> ${summary}</div>`;
            if (labels && labels.length > 0) analysisHtml += `<div>üè∑Ô∏è Objects: ${labels.slice(0, 3).map(l => l.description).join(', ')}</div>`;
            if (personDetection && personDetection.totalCount > 0) {
                analysisHtml += `<div>üë• People: ${personDetection.totalCount}</div>`;
                totalPeopleDetected += personDetection.totalCount;
            }
            if (crowdAnalysis) {
                analysisHtml += `<div>üìä Crowd: ${crowdAnalysis.density} density</div><div>‚ö†Ô∏è Risk: ${crowdAnalysis.riskLevel}</div>`;
                if (crowdAnalysis.riskLevel !== 'normal') currentRiskLevel = crowdAnalysis.riskLevel.toUpperCase();
            }
            analysisElement.innerHTML = analysisHtml;
            if (activeStreams.has(data.deviceId)) {
                const stream = activeStreams.get(data.deviceId);
                stream.lastAnalysis = data;
                activeStreams.set(data.deviceId, stream);
            }
            updateStats();
        }

        function updateAnalysisError(deviceId, error) {
            const analysisElement = document.getElementById(`analysis-${deviceId}`);
            if (analysisElement) {
                analysisElement.innerHTML = `<div class="analysis-title">ü§ñ AI Analysis</div><div class="analysis-error">‚ùå Analysis failed: ${error}</div>`;
            }
        }

        function addAlert(alertData) {
            alerts.unshift({ ...alertData, id: Date.now() });
            if (alerts.length > 10) alerts.splice(10);
            renderAlerts();
            updateStats();
        }

        function renderAlerts() {
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="loading">No alerts</div>';
                return;
            }
            alertsContainer.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.alerts[0]?.severity || 'warning'}">
                    <div style="font-weight: bold; margin-bottom: 8px;">üì± Device: ${alert.deviceId.substring(0, 8)}...</div>
                    <div style="font-size: 0.9em; margin-bottom: 8px;">${alert.alerts.map(a => a.message).join('<br>')}</div>
                    <div style="font-size: 0.8em; opacity: 0.7;">‚è∞ ${formatTime(alert.timestamp)}</div>
                </div>
            `).join('');
        }

        function updateStats() {
            activeStreamsCount.textContent = activeStreams.size;
            totalAlertsCount.textContent = alerts.length;
            peopleDetectedCount.textContent = totalPeopleDetected;
            riskLevelElement.textContent = currentRiskLevel;
            const riskColors = { 'NORMAL': '#00ff00', 'ELEVATED': '#ffa500', 'HIGH': '#ff0000', 'CRITICAL': '#ff0000' };
            riskLevelElement.style.color = riskColors[currentRiskLevel] || '#00ff00';
        }

        async function loadActiveStreams() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/streams`, { headers: { 'ngrok-skip-browser-warning': 'true' } });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const data = await response.json();
                streamsGrid.innerHTML = '';
                if (data.streams.length === 0) {
                    streamsGrid.innerHTML = '<div class="loading">No active streams</div>';
                } else {
                    data.streams.forEach(stream => {
                        addStream(stream.deviceId, stream.sessionId, stream.startTime, stream.videoStreamActive);
                    });
                }
                updateStats();
            } catch (error) {
                console.error('‚ùå Error loading streams:', error);
                streamsGrid.innerHTML = '<div class="loading">Error connecting to server</div>';
            }
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        setInterval(loadActiveStreams, 30000);
    </script>
</body>
</html>